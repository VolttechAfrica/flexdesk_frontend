"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[525,780],{35525:(e,t,r)=>{r.d(t,{authService:()=>s});var o=r(92844),a=r(20395);class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}endPoints(){return{LOGIN:"/auth/login",LOGOUT:"/auth/logout",REFRESH_TOKEN:"/auth/token/refresh"}}async login(e){try{var t;let{data:r,status:n,message:i}=await o.uE.post(this.endPoints().LOGIN,e);if(!n)throw Error(i||"Login failed");return a.Rm.info("Login successful",{userId:null===(t=r.user)||void 0===t?void 0:t.id,action:"login_success"}),this.setAuthUser(r.user),this.setAccessTokenFallback(r.accessToken),this.setRefreshTokenFallback(r.refreshToken),r}catch(e){if(a.Rm.error("Login service error",e,{action:"login_error"}),e instanceof Error)throw e;throw Error("Network error occurred")}}async logout(){try{let e=this.getAuthUser(),t=await o.uE.post(this.endPoints().LOGOUT);return a.Rm.auth("User logout successful",null==e?void 0:e.id),t.data}catch(e){a.Rm.error("Logout error",e,{action:"logout_error"})}finally{this.clearAuthData()}}async refreshToken(e){let{token:t}=e;try{var r;if(!t)throw Error("Token is required");let e=null===(r=this.getAuthUser())||void 0===r?void 0:r.id;if(!e)throw Error("User ID is required");let{data:{token:n,status:i}}=await o.uE.post(this.endPoints().REFRESH_TOKEN);if(!i)throw Error("Authentication error, login again");this.setAccessTokenFallback(n),a.Rm.auth("Token refresh successful",e)}catch(e){if(a.Rm.error("Refresh token error",e,{action:"token_refresh_error"}),e instanceof Error)throw e;throw Error("Network error occurred")}}setRefreshTokenFallback(e){if(!i()){a.Rm.warn("Client-side token storage should not be used in production",{action:"security_warning"});return}try{if(!e)throw Error("Token is required");{let t="https:"===window.location.protocol;document.cookie="refresh_token=".concat(e,"; path=/; max-age=604800; ").concat(t?"secure; ":"","samesite=").concat(t?"strict":"lax")}}catch(e){throw Error(e)}}setAccessTokenFallback(e){if(!i()){a.Rm.warn("Client-side token storage should not be used in production",{action:"security_warning"});return}try{if(!e)throw Error("Token is required");{let t="https:"===window.location.protocol;document.cookie="access_token=".concat(e,"; path=/; max-age=3600; ").concat(t?"secure; ":"","samesite=").concat(t?"strict":"lax")}}catch(e){throw Error(e)}}setAuthUser(e){{let t={id:e.id,firstName:e.firstName,lastName:e.lastName,email:e.email,roleId:e.roleId,userType:e.userType,profile:null==e?void 0:e.profile,school:null==e?void 0:e.school,assignedClasses:null==e?void 0:e.assignedClasses,assignedSubjects:null==e?void 0:e.assignedSubjects};localStorage.setItem("user",JSON.stringify(t))}}getAuthUser(){try{let e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){a.Rm.error("Error parsing user data",e,{action:"user_data_parse_error"}),localStorage.removeItem("user")}return null}clearAuthData(){{localStorage.removeItem("user");let e="https:"===window.location.protocol,t=e?"secure; ":"",r=e?"strict":"lax";document.cookie="access_token=; path=/; max-age=0; ".concat(t,"samesite=").concat(r),document.cookie="refresh_token=; path=/; max-age=0; ".concat(t,"samesite=").concat(r),a.Rm.info("Auth data cleared",{action:"auth_data_clear"})}}getStoredToken(){var e;return i()&&(null===(e=document.cookie.split("; ").find(e=>e.startsWith("access_token=")))||void 0===e?void 0:e.split("=")[1])||null}isTokenExpired(e){try{if(!e||"string"!=typeof e)return!0;let t=e.split(".");if(3!==t.length)return!0;let r=JSON.parse(atob(t[1])),o=Math.floor(Date.now()/1e3);if(!r.exp||"number"!=typeof r.exp)return!0;return r.exp<o+300}catch(e){return i()&&a.Rm.error("Token validation error",e,{action:"token_validation_error"}),!0}}getTokenExpiration(e){try{if(!e||"string"!=typeof e)return null;let t=e.split(".");if(3!==t.length)return null;let r=JSON.parse(atob(t[1]));if(!r.exp||"number"!=typeof r.exp)return null;return new Date(1e3*r.exp)}catch(e){return i()&&a.Rm.error("Error getting token expiration",e,{action:"token_expiration_error"}),null}}isValidTokenFormat(e){try{if(!e||"string"!=typeof e)return!1;let t=e.split(".");if(3!==t.length)return!1;let r=JSON.parse(atob(t[0])),o=JSON.parse(atob(t[1]));return r.alg&&o.exp&&o.iat}catch(e){return!1}}constructor(){}}function i(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("localhost")||window.location.hostname.includes("192.168.2.43")}let s=n.getInstance()},49226:(e,t,r)=>{r.d(t,{s:()=>o});let o={801:"/admin/dashboard",802:"/superadmin/dashboard",800:"/superadmin/dashboard",803:"/teacher/dashboard",805:"/parent/dashboard",804:"/student/dashboard",807:"/bursar/dashboard"}},53580:(e,t,r)=>{r.d(t,{dj:()=>d,oR:()=>h});var o=r(12115);let a=0,n=new Map,i=e=>{if(n.has(e))return;let t=setTimeout(()=>{n.delete(e),u({type:"REMOVE_TOAST",toastId:e})},1e6);n.set(e,t)},s=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:r}=t;return r?i(r):e.toasts.forEach(e=>{i(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===r||void 0===r?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},c=[],l={toasts:[]};function u(e){l=s(l,e),c.forEach(e=>{e(l)})}function h(e){let{...t}=e,r=(a=(a+1)%Number.MAX_SAFE_INTEGER).toString(),o=()=>u({type:"DISMISS_TOAST",toastId:r});return u({type:"ADD_TOAST",toast:{...t,id:r,open:!0,onOpenChange:e=>{e||o()}}}),{id:r,dismiss:o,update:e=>u({type:"UPDATE_TOAST",toast:{...e,id:r}})}}function d(){let[e,t]=o.useState(l);return o.useEffect(()=>(c.push(t),()=>{let e=c.indexOf(t);e>-1&&c.splice(e,1)}),[e]),{...e,toast:h,dismiss:e=>u({type:"DISMISS_TOAST",toastId:e})}}},53999:(e,t,r)=>{r.d(t,{cn:()=>n});var o=r(52596),a=r(39688);function n(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,a.QP)((0,o.$)(t))}},66258:(e,t,r)=>{r.d(t,{A:()=>d,AuthProvider:()=>h});var o=r(95155),a=r(12115),n=r(35695),i=r(35525),s=r(49226),c=r(53580),l=r(20395);let u=(0,a.createContext)(void 0);function h(e){let{children:t}=e,[r,h]=(0,a.useState)(null),[d,f]=(0,a.useState)(null),[g,k]=(0,a.useState)([]),[p,m]=(0,a.useState)(!0),[S,_]=(0,a.useState)(null),T=(0,n.useRouter)(),w=!!d&&!!r;(0,a.useEffect)(()=>{(async()=>{try{let e=i.authService.getStoredToken(),t=i.authService.getAuthUser();if(e&&t){if(i.authService.isTokenExpired(e))try{await i.authService.refreshToken({token:e});let r=i.authService.getStoredToken();r?(f(r),h(t),l.Rm.auth("Auth initialized with refreshed token",t.id)):(i.authService.clearAuthData(),l.Rm.warn("Token refresh failed during initialization",{action:"init_token_refresh_failed"}))}catch(e){i.authService.clearAuthData(),l.Rm.error("Token refresh failed during initialization",e,{action:"init_token_refresh_error"})}else f(e),h(t),l.Rm.auth("Auth initialized with existing token",t.id)}}catch(e){l.Rm.error("Auth initialization error",e,{action:"auth_init_error"})}finally{m(!1)}})()},[]),(0,a.useEffect)(()=>{if(!d)return;let e=setInterval(async()=>{try{let e=i.authService.getStoredToken();if(e&&i.authService.isTokenExpired(e)){await i.authService.refreshToken({token:e});let t=i.authService.getStoredToken();t&&(f(t),l.Rm.info("Auto token refresh successful",{action:"auto_token_refresh_success"}))}}catch(e){l.Rm.error("Auto token refresh failed",e,{action:"auto_token_refresh_failed"}),m(!1),await y()}},3e5);return()=>clearInterval(e)},[d]);let v=async e=>{try{m(!0),_(null);let t=await i.authService.login(e);console.log("This is the new login response",t);let{user:r,accessToken:o,permissions:a}=t;if(h(r),f(o),k(a),r.firstTimeLogin)T.replace("/onboarding");else{let e=r.roleId,t=s.s[e];l.Rm.user("Redirecting to role dashboard",r.id,{action:"redirect_dashboard",roleId:e,redirectPath:t}),T.replace(t)}}catch(e){throw _(e instanceof Error?e.message:"Login failed"),l.Rm.error("Login failed in context",e,{action:"context_login_error"}),e}finally{m(!1)}},y=async()=>{try{d&&await i.authService.logout()}catch(e){l.Rm.error("Logout error in context",e,{action:"context_logout_error"})}finally{h(null),f(null),k([]),_(null),i.authService.clearAuthData(),T.replace("/login"),(0,c.oR)({title:"Logged Out",description:"You have been successfully logged out.",variant:"default"})}},E=async()=>{try{let e=i.authService.getStoredToken();if(e){await i.authService.refreshToken({token:e});let t=i.authService.getStoredToken();t&&(f(t),l.Rm.info("Manual token refresh successful",{action:"manual_token_refresh_success"}))}}catch(e){l.Rm.error("Manual token refresh failed",e,{action:"manual_token_refresh_failed"}),await y()}};return(0,o.jsx)(u.Provider,{value:{user:r,token:d,permissions:g,isAuthenticated:w,isLoading:p,error:S,login:v,logout:y,refreshAuth:E},children:t})}function d(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);